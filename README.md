msgq_flood -- Erlang VM でメッセージキューがたまると困る問題の再現コード
=================================================================

現象と課題
---------

Erlang VM の軽量プロセスのメッセージキューが数万を超えると、
メッセージキューの吸い込み速度が極端に遅くなる。

たとえば、以下の構成で、log_serve が複数のプロセスからのメッセージを受け付けているとき、
log_server のメッセージキュー長が増えると発生する。

```
  +----------------+        +------------+
  | sender process | -----> | log_server | ---> (file write)
  +----------------+     -> +------------+
                        / 
  +----------------+   / 
  | sender process | -/
  +----------------+
```
  
これを、以下の構成にすると、回避できる。
dam が log_server の前に入って、log_server のメッセージキュー長を見ながら
たまりすぎないように調整すると、dam 自身は遅くならなず、 log_server の遅延も発生しない。

```
  +----------------+        +-----+      +------------+
  | sender process | -----> | dam | ---> | log_server | ---> (file write)
  +----------------+     -> +-----+      +------------+
                        / 
  +----------------+   / 
  | sender process | -/
  +----------------+
```

この動作を再現するのが、本コードである。

使い方
------

事前に erlan shell を起動しておく。

### log_server のキュー処理が遅くなる現象を再現

```
%% モジュール読み込み
1> c(msgq_flood).
{ok,msgq_flood}

%% ログサーバとダム起動 (書き込み先は "a.log")
2> msgq_flood:start_link("a.log").
{ok,<0.67.0>}

%% プロセス確認
3> whereis(log_server).
<0.67.0>
4> whereis(log_dam).   
<0.68.0>

%% log_server に直接大量のメッセージを送る (100プロセス x 1万通 = 100万通)
5> msgq_flood:flood_direct(100, 10000).
ok

%% キュー残数と差分を観測する
6> msgq_flood:watch().
DateTime                        dam msgq (diff) server msgq (diff)
2019-06-30T08:26:47.392Z        0 (0)   795310 (0)
2019-06-30T08:26:48.395Z        0 (0)   999293 (203983)
2019-06-30T08:26:49.396Z        0 (0)   999221 (-72)
2019-06-30T08:26:50.397Z        0 (0)   999153 (-68)
2019-06-30T08:26:51.398Z        0 (0)   999083 (-70)
%% log_server のキュー吸い込みレートが 100通/秒 未満
```

このとき、Erlang VM は1コア占有状態になっている。

```
PID    COMMAND      %CPU  TIME     #TH   #WQ  #PORTS MEM    PURG   CMPRS  PGRP
60728  beam.smp     100.9 01:48.63 32/1  0    54     189M+  0B     0B     60728
```

### dam を経由すると遅くならないことを再現

```
%% モジュール読み込み
1> c(msgq_flood).
{ok,msgq_flood}

%% ログサーバとダム起動 (書き込み先は "a.log")
2> msgq_flood:start_link("a.log").
{ok,<0.67.0>}

%% dam に直接大量のメッセージを送る (100プロセス x 1万通 = 100万通)
3> msgq_flood:flood_to_dam(100, 10000).
ok

%% キュー残数と差分を観測する
4> msgq_flood:watch().
DateTime                        dam msgq (diff) server msgq (diff)
2019-06-30T08:34:24.366Z        329062 (0)      1999 (0)
2019-06-30T08:34:25.368Z        476762 (147700) 107 (-1892)
2019-06-30T08:34:26.369Z        610306 (133544) 9784 (9677)
2019-06-30T08:34:27.370Z        666357 (56051)  9526 (-258)
2019-06-30T08:34:28.371Z        658809 (-7548)  9223 (-303)
2019-06-30T08:34:29.372Z        651221 (-7588)  9729 (506)
%% dam の吸い込みレートは　数千通/秒 を維持
```

トライアル
----------

dam とlog_server の処理を変えたら現象が変化しないか、試した記録。

### log_server のファイル書き込みをやめる

現象発生せず。
数秒で100万通の吸い込みが完了。

### ログ書き込み先を /dev/null にする

現象は変わらず。
ファイルシステムへの書き込みが問題なわけではなさそう。

### file:open のオプションを変えてみる

* append, raw, delayed_write → 再現 （元々のコード）
* append, raw → 再現
* append → 現象再現せず！
* append, delayed_write → 現象再現せず！

`raw` を指定しなければ遅くならない。
これが原因か？


